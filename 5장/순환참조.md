# 5장 순환 참조

## 인트로

>
> **순환 참조**
두 개 이상의 객체나 컴포넌트가 서로를 참조해 의존 관계에 사이클이 생기는 상황


- **예시** :  양방향 참조(객체 A가 객체 B를, 객체 B가 객체 A를 참조)

**코드 5.1**

```java
@Data
class Team{
    private long id;
    private String name;
    private List<Member> members;
}

@Data
class Member{
    private long id;
    private String name;
    private Team myTeam;
}
```

- **팀** : 팀원 목록 가지고 있음
- **팀원** : 자신이 소속된 팀을 참조

→ 순환 참조 발생 !!

**코드 5.2**

Team과 Member 클래스에 JPA의 @Entity 에너테이션을 적용하고 @OneToMay 와 @ManyToOne 애너테이션을 이용해 양방향 매핑을 적용함.  

TeamJpaEntity와 MemberJpaEntity 클래스가 서로를 참조함.

> JPA의 **양방향 매핑은 순환 참조**이다.
> 

양방향 매핑이라고 부른다 해서 순환 참조가 아닌 것은 아니다. 양방향 매핑은 수많은 순환 참조 사례 중 하나이다.

**코드 5.3**

두 서비스 컴포넌트가 서로를 참고하고 있다. → 순환 참조 발생 !!

코드는 잘 동작하지만, **참조 관계가 이렇게 괜찮은가?**를 생각해 보아야 한다.

순환 참조가 발생한다 → **서로에게 강하게 의존**하고 있다.

순환 참조가 있는 컴포넌트는 SOLID 하지 않다 !!

## 5.1 순환 참조의 문제점

### 5.1.1 무한 루프

순환 참조는 **무한 루프**를 유발할 수 있음.

개발자가 주의해도 예측할 수 없으므로 **순환 참조 자체를 만들지 말아야 함.**

### 5.1.2 시스템 복잡도

순환 참조는 시스템의 복잡도를 높인다. 

순환 참조로 인해 접근 경로가 많아져 시스템의 **복잡도**가 높아짐.

## 5.2 순환 참조를 해결하는 방법

### 5.2.1 불필요한 참조 제거

- 양방향 참조가 꼭 필요한지 검토
- 식별자를 통해 **간접 참조** 형태로 변경 가능

**코드 5.9**

```java
// TeamJpaEntity에서 members 변수를 제거
// 팀원 목록은 아래와 같이 불러오기
MemberJpaRepository.findByTeamId(teamId);
```

이렇게 조금만 의식해서 생각해보면 불필요한 참조 관계를 많이 제거할 수 있을 것이다. 

### 5.2.2 간접 참조 활용

직접 참조 대신, 식별값을 이용해 참조

**코드 5.10**

```java
MemberJpaEntity {
		// private TeamJpaEntity myTeam;
    private long myTeamId;
    // TeamJpaRepository.findById(myTeamId)로 팀 정보 찾기
}
```

### 5.2.3 공통 컴포넌트 분리

순환 참조가 필수적일 때, **공통 컴포넌트로 분리**

- 양쪽 서비스가 **공통 컴포넌트**에 의존
- 책임 분배가 적절히 이루어져 기능적 응집도 상승

### 5.2.4 이벤트 기반 시스템 사용

서비스를 공통 컴포넌트로 분리할 수 없다면 **이벤트 기반 프로그래밍**을 시스템에 적용하여 순환 참조를 방지할 수 있음. 이 방식은 시스템 설계를 더 유연하게 만들어주며, 상호 의존성을 줄여줌

**이벤트 기반 시스템 구조:**

1. **중앙 큐 생성** : 시스템에서 사용할 이벤트 큐 생성
2. **컴포넌트가 큐를 구독** : 필요한 컴포넌트들이 중앙 큐를 구독
3. **이벤트 발행** : 컴포넌트가 다른 컴포넌트에 작업을 요청할 때, 큐에 이벤트를 발행
4. **이벤트 처리** : 구독 중인 컴포넌트들이 큐에서 이벤트를 확인하고, 자신이 처리할 이벤트라면 이를 처리

이 구조에서 서비스는 더 이상 **직접 상호 참조**하지 않음. 대신 **이벤트와 이벤트 큐에 의존**함.

**이벤트 기반 시스템의 장점:**

- **결합도 감소** : 컴포넌트 간의 직접적인 참조 없이 이벤트로 통신하므로 결합도 낮아짐
- **유연성 증가** : 순환 참조 없이도 의존성 관리가 가능
- **구조 단순화** : 복잡한 의존 관계를 제거하면서 시스템을 단순하게 유지

스프링을 이용하면 이벤트 시스템을 쉽게 구현할 수 있다.

`AppliacationEvent`, `ApplicationEventPublisher`, `EventListner` 등 이용

**스프링 없이도 적용 가능**

반드시 스프링을 사용하지 않아도, 중앙 큐만 있으면 어디서든 이벤트 기반 시스템을 적용할 . 수있음. 큐에 쌓인 이벤트를 동기 또는 비동기 방식으로 처리할 수도 있음

> 이벤트 기반 프로그래밍(EDP)은 순환 참조를 방지하고 시스템을 유연하게 만들어 주는 효과적 방법
> 

## 5.3 양방향 매핑

JPA에 **양방향 매핑**이라는 개념이 존재하지만, 이를 **적극적으로 사용해야 한다는 뜻은 아님.**

순환 참조는 어떻게 해서든 **없애는 것이 좋으며, 대부분 제거 가능함**

**양방향 매핑의 적절한 사용**

- 양방향 매핑은 도메인 설계 과정에서 **불가피한 경우에만** 사용
- 양방향 매핑 없이도 얼마든지 개발이 가능하며, JPA는 **설계에 영향을 주는 수단이 아니라 도구**에 불과함.
- **순환 참조 없는 도메인 설계**가 우선이며, 그 후에 JPA를 연동하는 방식으로 개발하는 것이 이상적

## 5.4 상위 수준의 순환 참조

순환 참조는 **객체 간**뿐만 아니라 **패키지, 시스템, 모듈 수준**에서도 발생할 수 있음.

상위 수준 순환 참조의 문제점

- 패키지나 시스템 수준에서 순환 참조가 발생하면 **객체 간 순환 참조보다 더 큰 문데 유발**
- **분리와 유연성**이 제한되어, 시스템 확장성과 관리가 어려워짐

따라서 개발자는 **클래스뿐만 아니라 상위 수준에서의 순환 참조도 방지하**는 데 주의해야 함.

> **순환 참조는 명백한 안티패턴**이므로, 시스템 설계 시 이를 방지하는 것이 매우 중요하다.
>
